{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="glowing-title">üìä Tableau de Bord - La Gloire de Dieu</h1>
        <p class="subtitle">Statistiques compl√®tes et pr√©visions</p>
    </div>

    <!-- Cartes de statistiques principales -->
    <div class="stats-grid">
        <div class="stat-card gradient-blue">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
                <h3>{{ total_produits }}</h3>
                <p>Produits actifs</p>
            </div>
            <div class="stat-glow"></div>
        </div>

        <div class="stat-card gradient-green">
            <div class="stat-icon">üè∑Ô∏è</div>
            <div class="stat-content">
                <h3>{{ total_categories }}</h3>
                <p>Cat√©gories</p>
            </div>
            <div class="stat-glow"></div>
        </div>

        <div class="stat-card gradient-purple">
            <div class="stat-icon">üõí</div>
            <div class="stat-content">
                <h3>{{ total_commandes }}</h3>
                <p>Commandes totales</p>
            </div>
            <div class="stat-glow"></div>
        </div>

        <div class="stat-card gradient-orange">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <h3>{{ valeur_stock_total|floatformat:0 }} FCFA</h3>
                <p>Valeur du stock</p>
            </div>
            <div class="stat-glow"></div>
        </div>
    </div>

    <!-- Statistiques financi√®res -->
    <div class="section-title">
        <h2>üíµ Statistiques Financi√®res</h2>
    </div>

    <div class="stats-grid">
        <div class="stat-card gradient-gold">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-content">
                <h3>{{ ventes_aujourdhui|floatformat:0 }} FCFA</h3>
                <p>Aujourd'hui ({{ nombre_ventes_aujourdhui }} ventes)</p>
            </div>
            <div class="stat-glow"></div>
        </div>

        <div class="stat-card gradient-cyan">
            <div class="stat-icon">üìÜ</div>
            <div class="stat-content">
                <h3>{{ ventes_semaine|floatformat:0 }} FCFA</h3>
                <p>Cette semaine ({{ nombre_ventes_semaine }} ventes)</p>
            </div>
            <div class="stat-glow"></div>
        </div>

        <div class="stat-card gradient-pink">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <h3>{{ ventes_mois|floatformat:0 }} FCFA</h3>
                <p>Ce mois ({{ nombre_ventes_mois }} ventes)</p>
            </div>
            <div class="stat-glow"></div>
        </div>

        <div class="stat-card gradient-indigo">
            <div class="stat-icon">üìà</div>
            <div class="stat-content">
                <h3>{{ ventes_annee|floatformat:0 }} FCFA</h3>
                <p>Cette ann√©e ({{ nombre_ventes_annee }} ventes)</p>
            </div>
            <div class="stat-glow"></div>
        </div>
    </div>

    <!-- Graphique des ventes -->
    <div class="chart-container">
        <div class="chart-card">
            <h3>üìà Tendances des Ventes (7 derniers jours)</h3>
            <canvas id="ventesChart"></canvas>
        </div>
    </div>

    <!-- Statistiques Min/Max -->
    <div class="section-title">
        <h2>üìä Statistiques Min/Max</h2>
    </div>

    <div class="minmax-grid">
        <div class="minmax-card">
            <h4>üí∞ Prix</h4>
            <div class="minmax-content">
                <div class="minmax-item">
                    <span class="label">Minimum:</span>
                    <span class="value">{{ produits_stats.prix_min|floatformat:0 }} FCFA</span>
                </div>
                <div class="minmax-item">
                    <span class="label">Maximum:</span>
                    <span class="value">{{ produits_stats.prix_max|floatformat:0 }} FCFA</span>
                </div>
                <div class="minmax-item">
                    <span class="label">Moyenne:</span>
                    <span class="value">{{ produits_stats.prix_moyen|floatformat:0 }} FCFA</span>
                </div>
            </div>
        </div>

        <div class="minmax-card">
            <h4>üì¶ Stock</h4>
            <div class="minmax-content">
                <div class="minmax-item">
                    <span class="label">Minimum:</span>
                    <span class="value">{{ produits_stats.stock_min }}</span>
                </div>
                <div class="minmax-item">
                    <span class="label">Maximum:</span>
                    <span class="value">{{ produits_stats.stock_max }}</span>
                </div>
                <div class="minmax-item">
                    <span class="label">Moyenne:</span>
                    <span class="value">{{ produits_stats.stock_moyen|floatformat:0 }}</span>
                </div>
            </div>
        </div>

        <div class="minmax-card">
            <h4>üíé Marge</h4>
            <div class="minmax-content">
                <div class="minmax-item">
                    <span class="label">Minimum:</span>
                    <span class="value">{{ produits_stats.marge_min|floatformat:0 }} FCFA</span>
                </div>
                <div class="minmax-item">
                    <span class="label">Maximum:</span>
                    <span class="value">{{ produits_stats.marge_max|floatformat:0 }} FCFA</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Pr√©visions -->
    <div class="section-title">
        <h2>üîÆ Pr√©visions</h2>
    </div>

    <div class="forecast-card">
        <div class="forecast-content">
            <div class="forecast-icon">üìä</div>
            <div>
                <h3>Pr√©vision du mois prochain</h3>
                <p class="forecast-amount">{{ prevision_mois|floatformat:0 }} FCFA</p>
                <p class="forecast-note">Bas√©e sur la moyenne des 3 derniers mois</p>
            </div>
        </div>
        <div class="forecast-glow"></div>
    </div>

    <!-- Top produits -->
    <div class="section-title">
        <h2>‚≠ê Top 10 Produits Vendus (Ce mois)</h2>
    </div>

    <div class="table-container">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Rang</th>
                    <th>Produit</th>
                    <th>Quantit√© vendue</th>
                    <th>Montant total</th>
                </tr>
            </thead>
            <tbody>
                {% for produit in top_produits %}
                <tr>
                    <td class="rank">{{ forloop.counter }}</td>
                    <td>{{ produit.produit__nom }}</td>
                    <td>{{ produit.quantite_vendue }}</td>
                    <td class="amount">{{ produit.total_ventes|floatformat:0 }} FCFA</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="no-data">Aucune vente ce mois</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Statistiques par cat√©gorie -->
    <div class="section-title">
        <h2>üìÅ Statistiques par Cat√©gorie</h2>
    </div>

    <div class="category-grid">
        {% for stat in stats_categories %}
        <div class="category-card">
            <h4>{{ stat.nom }}</h4>
            <div class="category-stats">
                <div class="category-stat">
                    <span class="category-label">Produits:</span>
                    <span class="category-value">{{ stat.nombre_produits }}</span>
                </div>
                <div class="category-stat">
                    <span class="category-label">Valeur stock:</span>
                    <span class="category-value">{{ stat.valeur_stock|floatformat:0 }} FCFA</span>
                </div>
                <div class="category-stat">
                    <span class="category-label">Ventes (mois):</span>
                    <span class="category-value">{{ stat.ventes_mois|floatformat:0 }} FCFA</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Alertes -->
    <div class="section-title">
        <h2>‚ö†Ô∏è Alertes</h2>
    </div>

    <div class="alerts-grid">
        {% if produits_stock_faible > 0 %}
        <div class="alert-card alert-warning">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div class="alert-content">
                <h4>Stock faible</h4>
                <p>{{ produits_stock_faible }} produit(s) n√©cessitent un r√©approvisionnement</p>
            </div>
        </div>
        {% endif %}

        {% if commandes_en_attente > 0 %}
        <div class="alert-card alert-info">
            <div class="alert-icon">üìã</div>
            <div class="alert-content">
                <h4>Commandes en attente</h4>
                <p>{{ commandes_en_attente }} commande(s) en attente de traitement</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Graphique des ventes
    const ventesData = {{ ventes_par_jour|safe }};
    const ctx = document.getElementById('ventesChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ventesData.map(item => item.date),
            datasets: [{
                label: 'Ventes (FCFA)',
                data: ventesData.map(item => item.total),
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: 'rgb(99, 102, 241)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: '#fff'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#fff',
                        font: {
                            size: 12
                        },
                        callback: function(value) {
                            return value.toLocaleString() + ' FCFA';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#fff',
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
</script>
{% endblock %}

